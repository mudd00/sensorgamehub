<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ“± Sensor Controller v6.0</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #0f172a;
            --surface: #1e293b;
            --card: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #475569;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }
        
        /* í—¤ë” */
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1.5rem;
            min-height: calc(100vh - 120px);
        }
        
        /* ì—°ê²° ìƒíƒœ */
        .connection-status {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.75rem;
            background: var(--error);
            transition: background-color 0.3s ease;
        }
        
        .status-indicator.connected {
            background: var(--success);
            box-shadow: 0 0 12px var(--success);
        }
        
        .status-text {
            font-size: 1rem;
            font-weight: 600;
            display: inline-block;
            vertical-align: middle;
        }
        
        /* ì„¸ì…˜ ì…ë ¥ */
        .session-input-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .session-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            text-align: center;
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            letter-spacing: 0.2em;
            transition: border-color 0.3s ease;
        }
        
        .session-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .session-input::placeholder {
            color: var(--text-muted);
            letter-spacing: normal;
        }
        
        .connect-button {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .connect-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .connect-button:active {
            transform: translateY(0);
        }
        
        .connect-button:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
        }
        
        /* QR ìŠ¤ìºë„ˆ */
        .qr-scanner-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .qr-button {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .qr-button:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }
        
        /* ê²Œì„ ì •ë³´ */
        .game-info {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .game-info.visible {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .game-type-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            background: var(--primary);
            color: white;
            border-radius: 1rem;
            margin-bottom: 1rem;
        }
        
        .game-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .detail-item {
            text-align: center;
        }
        
        .detail-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* ì„¼ì„œ ìƒíƒœ */
        .sensor-status {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .sensor-status.visible {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .sensor-item {
            text-align: center;
            padding: 1rem;
            background: var(--background);
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }
        
        .sensor-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sensor-value {
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            color: var(--primary);
        }
        
        /* í™œë™ í‘œì‹œ */
        .activity-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 4px solid var(--primary);
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.1);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .activity-indicator.active {
            display: flex;
            animation: pulse 1s infinite;
        }
        
        .activity-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
        }
        
        /* ë©”ì‹œì§€ */
        .message {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        
        .message.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }
        
        .message.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }
        
        .message.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }
            
            .session-input-section,
            .qr-scanner-section,
            .game-info,
            .sensor-status {
                padding: 1rem;
            }
            
            .sensor-grid {
                grid-template-columns: 1fr;
            }
            
            .game-details {
                grid-template-columns: 1fr;
            }
        }
        
        /* í”Œë ˆì´ì–´ ì •ë³´ ì¹´ë“œ */
        .player-info-card {
            background: var(--card);
            border: 2px solid var(--primary);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: fadeIn 0.5s ease;
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .player-number {
            font-size: 1.8rem;
            font-weight: 800;
        }
        
        .player-details {
            flex: 1;
        }
        
        .player-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .player-id {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }
        
        /* í”Œë ˆì´ì–´ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
        .player-color-1 { background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important; }
        .player-color-2 { background: linear-gradient(135deg, #ef4444, #dc2626) !important; }
        .player-color-3 { background: linear-gradient(135deg, #10b981, #059669) !important; }
        .player-color-4 { background: linear-gradient(135deg, #f59e0b, #d97706) !important; }
        .player-color-5 { background: linear-gradient(135deg, #8b5cf6, #7c3aed) !important; }
        .player-color-6 { background: linear-gradient(135deg, #06b6d4, #0891b2) !important; }
        .player-color-7 { background: linear-gradient(135deg, #f97316, #ea580c) !important; }
        .player-color-8 { background: linear-gradient(135deg, #84cc16, #65a30d) !important; }
        
        /* ìˆ¨ê¹€ í´ë˜ìŠ¤ */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <div class="header-content">
            <div class="logo">ğŸ“± Sensor Controller v6.0</div>
            <div class="subtitle">ëª¨ë°”ì¼ ì„¼ì„œë¥¼ ê²Œì„ ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ ì‚¬ìš©í•˜ì„¸ìš”</div>
        </div>
    </div>
    
    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="container">
        <!-- ì—°ê²° ìƒíƒœ -->
        <div class="connection-status">
            <div class="status-indicator" id="statusIndicator"></div>
            <span class="status-text" id="statusText">ì„œë²„ ì—°ê²° ì¤‘...</span>
        </div>
        
        <!-- ë©”ì‹œì§€ -->
        <div class="message" id="message"></div>
        
        <!-- ì„¸ì…˜ ì…ë ¥ -->
        <div class="session-input-section" id="sessionInputSection">
            <div class="section-title">ğŸ® ê²Œì„ ì„¸ì…˜ ì—°ê²°</div>
            <div class="input-group">
                <label class="input-label">4ìë¦¬ ì„¸ì…˜ ì½”ë“œ ì…ë ¥</label>
                <input type="text" 
                       class="session-input" 
                       id="sessionInput" 
                       placeholder="0000"
                       maxlength="4"
                       pattern="[0-9]{4}"
                       inputmode="numeric">
            </div>
            <button class="connect-button" id="connectButton" disabled>
                ğŸ”— ê²Œì„ì— ì—°ê²°
            </button>
        </div>
        
        <!-- QR ìŠ¤ìºë„ˆ -->
        <div class="qr-scanner-section" id="qrScannerSection">
            <div class="section-title">ğŸ“· QR ì½”ë“œ ìŠ¤ìº”</div>
            <button class="qr-button" id="qrButton">
                ğŸ“· QR ì½”ë“œ ìŠ¤ìº”í•˜ê¸°
            </button>
            <div id="qr-reader" style="display: none; margin-top: 1rem;"></div>
        </div>
        
        <!-- ê²Œì„ ì •ë³´ -->
        <div class="game-info" id="gameInfo">
            <div class="section-title">ğŸ® ì—°ê²°ëœ ê²Œì„</div>
            <div class="game-type-badge" id="gameTypeBadge">SOLO</div>
            
            <!-- í”Œë ˆì´ì–´ ì •ë³´ ì¹´ë“œ -->
            <div class="player-info-card" id="playerInfoCard">
                <div class="player-avatar" id="playerAvatar">
                    <span class="player-number" id="playerNumber">?</span>
                </div>
                <div class="player-details">
                    <div class="player-name" id="playerName">í”Œë ˆì´ì–´</div>
                    <div class="player-id" id="playerId">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
                </div>
            </div>
            
            <div class="game-details">
                <div class="detail-item">
                    <div class="detail-label">ì—°ê²°ëœ í”Œë ˆì´ì–´</div>
                    <div class="detail-value" id="connectedSensors">0/1</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ê²Œì„ ìƒíƒœ</div>
                    <div class="detail-value" id="gameStatus">ëŒ€ê¸° ì¤‘</div>
                </div>
            </div>
            <button class="btn btn-primary" id="startSensorBtn" style="width: 100%; margin-top: 1rem;" disabled>
                ğŸ“± ì„¼ì„œ ì‹œì‘í•˜ê¸°
            </button>
        </div>
        
        <!-- ì„¼ì„œ ìƒíƒœ -->
        <div class="sensor-status" id="sensorStatus">
            <div class="section-title">ğŸ“Š ì‹¤ì‹œê°„ ì„¼ì„œ ë°ì´í„°</div>
            <div class="sensor-grid">
                <div class="sensor-item">
                    <div class="sensor-label">ê¸°ìš¸ê¸° X</div>
                    <div class="sensor-value" id="tiltX">0.0</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-label">ê¸°ìš¸ê¸° Y</div>
                    <div class="sensor-value" id="tiltY">0.0</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-label">íšŒì „ Z</div>
                    <div class="sensor-value" id="rotationZ">0.0</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-label">ê°€ì†ë„ X</div>
                    <div class="sensor-value" id="accelX">0.0</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-label">ê°€ì†ë„ Y</div>
                    <div class="sensor-value" id="accelY">0.0</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-label">ê°€ì†ë„ Z</div>
                    <div class="sensor-value" id="accelZ">0.0</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- í™œë™ í‘œì‹œ -->
    <div class="activity-indicator" id="activityIndicator">
        <div class="activity-text">ì„¼ì„œ í™œë™</div>
    </div>
    
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- QR Code Scanner (optional) -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- SessionSDK -->
    <script src="/js/SessionSDK.js"></script>
    
    <!-- Sensor Controller Script -->
    <script>
        class SensorController {
            constructor() {
                // SDK ì´ˆê¸°í™”
                this.sdk = new SessionSDK({
                    gameId: 'sensor-controller',
                    gameType: 'client',
                    debug: true
                });
                
                // ì„¼ì„œ ìˆ˜ì§‘ê¸°
                this.sensorCollector = new SensorCollector({
                    throttle: 33, // 33ms ê°„ê²© (30fps) - ì„±ëŠ¥ ìµœì í™”
                    sensitivity: 1
                });
                
                // ìƒíƒœ ê´€ë¦¬
                this.state = {
                    connected: false,
                    sessionConnected: false,
                    sensorActive: false,
                    currentSession: null
                };
                
                // DOM ìš”ì†Œ
                this.elements = {
                    statusIndicator: document.getElementById('statusIndicator'),
                    statusText: document.getElementById('statusText'),
                    message: document.getElementById('message'),
                    sessionInput: document.getElementById('sessionInput'),
                    connectButton: document.getElementById('connectButton'),
                    qrButton: document.getElementById('qrButton'),
                    gameInfo: document.getElementById('gameInfo'),
                    gameTypeBadge: document.getElementById('gameTypeBadge'),
                    connectedSensors: document.getElementById('connectedSensors'),
                    gameStatus: document.getElementById('gameStatus'),
                    sensorStatus: document.getElementById('sensorStatus'),
                    activityIndicator: document.getElementById('activityIndicator'),
                    sessionInputSection: document.getElementById('sessionInputSection'),
                    qrScannerSection: document.getElementById('qrScannerSection'),
                    startSensorBtn: document.getElementById('startSensorBtn'),
                    // í”Œë ˆì´ì–´ ì •ë³´ ìš”ì†Œë“¤
                    playerInfoCard: document.getElementById('playerInfoCard'),
                    playerAvatar: document.getElementById('playerAvatar'),
                    playerNumber: document.getElementById('playerNumber'),
                    playerName: document.getElementById('playerName'),
                    playerId: document.getElementById('playerId'),
                    // ì„¼ì„œ ë°ì´í„° í‘œì‹œ ìš”ì†Œë“¤
                    tiltX: document.getElementById('tiltX'),
                    tiltY: document.getElementById('tiltY'),
                    rotationZ: document.getElementById('rotationZ'),
                    accelX: document.getElementById('accelX'),
                    accelY: document.getElementById('accelY'),
                    accelZ: document.getElementById('accelZ')
                };
                
                this.initializeApp();
            }
            
            async initializeApp() {
                console.log('ğŸ“± ì„¼ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ v6.0 ì´ˆê¸°í™”');
                
                this.setupEventListeners();
                this.setupSDKEvents();
                
                // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì„¸ì…˜ ì½”ë“œ í™•ì¸
                const urlParams = new URLSearchParams(window.location.search);
                const sessionCode = urlParams.get('session');
                
                if (sessionCode) {
                    this.elements.sessionInput.value = sessionCode;
                    this.showMessage('URLì—ì„œ ì„¸ì…˜ ì½”ë“œë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.', 'success');
                }
                
                // ì„¼ì„œ ì§€ì› í™•ì¸
                this.checkSensorSupport();
            }
            
            setupEventListeners() {
                // ì„¸ì…˜ ì…ë ¥
                this.elements.sessionInput.addEventListener('input', (e) => {
                    const value = e.target.value.replace(/[^0-9]/g, '').slice(0, 4);
                    e.target.value = value;
                    
                    this.elements.connectButton.disabled = value.length !== 4 || !this.state.connected;
                });
                
                // ì—°ê²° ë²„íŠ¼
                this.elements.connectButton.addEventListener('click', () => {
                    this.connectToSession();
                });
                
                // QR ìŠ¤ìº” ë²„íŠ¼
                this.elements.qrButton.addEventListener('click', () => {
                    this.scanQRCode();
                });
                
                // ì„¼ì„œ ì‹œì‘ ë²„íŠ¼
                this.elements.startSensorBtn.addEventListener('click', () => {
                    this.startSensorCollection();
                });
                
                // ì—”í„°í‚¤ ì²˜ë¦¬
                this.elements.sessionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.elements.connectButton.disabled) {
                        this.connectToSession();
                    }
                });
            }
            
            setupSDKEvents() {
                // SDK ì—°ê²° ì´ë²¤íŠ¸
                this.sdk.on('connected', () => {
                    this.state.connected = true;
                    this.updateConnectionStatus('ì„œë²„ ì—°ê²°ë¨', true);
                    this.elements.connectButton.disabled = this.elements.sessionInput.value.length !== 4;
                });
                
                this.sdk.on('disconnected', () => {
                    this.state.connected = false;
                    this.state.sessionConnected = false;
                    this.updateConnectionStatus('ì„œë²„ ì—°ê²° ëŠê¹€', false);
                    this.elements.connectButton.disabled = true;
                    this.hideGameInfo();
                });
                
                this.sdk.on('connection-error', (data) => {
                    this.showMessage(`ì—°ê²° ì˜¤ë¥˜: ${data.error}`, 'error');
                });
                
                // ì„¼ì„œ ì—°ê²° ì„±ê³µ
                this.sdk.on('sensor-connection-success', (event) => {
                    console.log('ğŸ” ì„¼ì„œ ì—°ê²° ì„±ê³µ ì´ë²¤íŠ¸:', event);
                    const data = event.detail || event;
                    console.log('ğŸ” ì‹¤ì œ ë°ì´í„°:', data);
                    console.log('ğŸ” ë°ì´í„° êµ¬ì¡°:', JSON.stringify(data, null, 2));
                    
                    this.state.sessionConnected = true;
                    this.state.currentSession = data;
                    
                    this.updateConnectionStatus(`ê²Œì„ì— ì—°ê²°ë¨`, true);
                    this.showGameInfo(data);
                    this.updatePlayerInfo(data);
                    
                    // ì„¼ì„œ ì‹œì‘ ë²„íŠ¼ í™œì„±í™”
                    this.elements.startSensorBtn.disabled = false;
                    
                    const sensorId = data.sensorId || data.id || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    this.showMessage(`${sensorId}ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                });
                
                // ê²Œì„ ì‹œì‘
                this.sdk.on('game-started', (data) => {
                    this.showMessage('ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    this.elements.gameTypeBadge.textContent = `${data.gameType.toUpperCase()} - í”Œë ˆì´ ì¤‘`;
                    this.elements.gameStatus.textContent = 'í”Œë ˆì´ ì¤‘';
                });
                
                // í˜¸ìŠ¤íŠ¸ ì—°ê²° í•´ì œ
                this.sdk.on('host-disconnected', () => {
                    this.showMessage('ê²Œì„ í˜¸ìŠ¤íŠ¸ê°€ ì—°ê²°ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.', 'warning');
                    this.resetConnection();
                });
                
                // ì„¼ì„œ ì˜¤ë¥˜
                this.sdk.on('sensor-error', (data) => {
                    this.showMessage(`ì„¼ì„œ ì˜¤ë¥˜: ${data.error}`, 'error');
                });
            }
            
            async connectToSession() {
                const sessionCode = this.elements.sessionInput.value.trim();
                
                if (!sessionCode || sessionCode.length !== 4) {
                    this.showMessage('ì˜¬ë°”ë¥¸ 4ìë¦¬ ì„¸ì…˜ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                    return;
                }
                
                try {
                    this.elements.connectButton.disabled = true;
                    this.elements.connectButton.textContent = 'ì—°ê²° ì¤‘...';
                    
                    await this.sdk.connectSensor(sessionCode, {
                        userAgent: navigator.userAgent,
                        screenSize: `${screen.width}x${screen.height}`,
                        timestamp: Date.now()
                    });
                    
                } catch (error) {
                    this.showMessage(`ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                    this.elements.connectButton.disabled = false;
                    this.elements.connectButton.textContent = 'ğŸ”— ê²Œì„ì— ì—°ê²°';
                }
            }
            
            async scanQRCode() {
                try {
                    this.showMessage('QR ì½”ë“œ ìŠ¤ìºë„ˆ ì¤€ë¹„ ì¤‘...', 'warning');
                    
                    // QR ìŠ¤ìºë„ˆ ì»¨í…Œì´ë„ˆ í‘œì‹œ
                    const qrReaderDiv = document.getElementById('qr-reader');
                    qrReaderDiv.style.display = 'block';
                    
                    // QR ìŠ¤ìºë„ˆ ì´ˆê¸°í™”
                    const qrCodeScanner = new Html5QrcodeScanner("qr-reader", {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    });
                    
                    // ì„±ê³µ ì½œë°±
                    const onScanSuccess = (decodedText) => {
                        try {
                            console.log('QR ì½”ë“œ ìŠ¤ìº” ì„±ê³µ:', decodedText);
                            
                            // URLì—ì„œ ì„¸ì…˜ ì½”ë“œ ì¶”ì¶œ
                            const url = new URL(decodedText);
                            const sessionCode = url.searchParams.get('session');
                            
                            if (sessionCode && sessionCode.length === 4) {
                                this.elements.sessionInput.value = sessionCode;
                                this.showMessage('QR ì½”ë“œì—ì„œ ì„¸ì…˜ ì½”ë“œë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.', 'success');
                                qrCodeScanner.clear();
                                qrReaderDiv.style.display = 'none';
                            } else {
                                this.showMessage('ì˜¬ë°”ë¥¸ QR ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.', 'error');
                            }
                        } catch (err) {
                            console.error('QR ì½”ë“œ íŒŒì‹± ì˜¤ë¥˜:', err);
                            this.showMessage('QR ì½”ë“œë¥¼ í•´ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        }
                    };
                    
                    // ì˜¤ë¥˜ ì½œë°±
                    const onScanError = (error) => {
                        // ìŠ¤ìº” ì˜¤ë¥˜ëŠ” ì¼ë°˜ì ì´ë¯€ë¡œ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  UIì—ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
                        console.log(`QR ìŠ¤ìº” ì§„í–‰ ì¤‘: ${error}`);
                    };
                    
                    // QR ìŠ¤ìºë„ˆ ë Œë”ë§
                    qrCodeScanner.render(onScanSuccess, onScanError);
                    
                    this.showMessage('QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”.', 'success');
                    
                } catch (error) {
                    console.error('QR ìŠ¤ìº” ì‹¤íŒ¨:', error);
                    this.showMessage('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    
                    // QR ìŠ¤ìºë„ˆ ìˆ¨ê¸°ê¸°
                    const qrReaderDiv = document.getElementById('qr-reader');
                    if (qrReaderDiv) {
                        qrReaderDiv.style.display = 'none';
                    }
                }
            }
            
            async startSensorCollection() {
                try {
                    console.log('ğŸ” ì„¼ì„œ ìˆ˜ì§‘ ì‹œì‘ ì‹œë„...');
                    await this.sensorCollector.start();
                    this.state.sensorActive = true;
                    
                    // ì„¼ì„œ ë°ì´í„° í•¸ë“¤ëŸ¬
                    this.sensorCollector.onData((data) => {
                        console.log('ğŸ” ì„¼ì„œ ë°ì´í„° ìˆ˜ì‹ :', data);
                        this.updateSensorDisplay(data);
                        this.sendSensorData(data);
                        this.showActivity();
                    });
                    
                    this.elements.sensorStatus.classList.add('visible');
                    this.elements.startSensorBtn.textContent = 'âœ… ì„¼ì„œ í™œì„±í™”ë¨';
                    this.elements.startSensorBtn.disabled = true;
                    this.showMessage('ì„¼ì„œ ìˆ˜ì§‘ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    console.log('âœ… ì„¼ì„œ ìˆ˜ì§‘ ì‹œì‘ ì™„ë£Œ');
                    
                } catch (error) {
                    console.error('âŒ ì„¼ì„œ ì‹œì‘ ì‹¤íŒ¨:', error);
                    this.showMessage(`ì„¼ì„œ ì‹œì‘ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
            
            sendSensorData(data) {
                if (this.state.sessionConnected) {
                    console.log('ğŸ” ì„¼ì„œ ë°ì´í„° ì „ì†¡:', data);
                    this.sdk.sendSensorData(data);
                } else {
                    console.log('âš ï¸ ì„¸ì…˜ ì—°ê²°ë˜ì§€ ì•ŠìŒ - ì„¼ì„œ ë°ì´í„° ì „ì†¡ ë¶ˆê°€');
                }
            }
            
            updateSensorDisplay(data) {
                // ê¸°ìš¸ê¸° (orientation)
                this.elements.tiltX.textContent = (data.orientation.beta || 0).toFixed(1);
                this.elements.tiltY.textContent = (data.orientation.gamma || 0).toFixed(1);
                this.elements.rotationZ.textContent = (data.orientation.alpha || 0).toFixed(1);
                
                // ê°€ì†ë„ (acceleration)
                this.elements.accelX.textContent = (data.acceleration.x || 0).toFixed(2);
                this.elements.accelY.textContent = (data.acceleration.y || 0).toFixed(2);
                this.elements.accelZ.textContent = (data.acceleration.z || 0).toFixed(2);
            }
            
            showActivity() {
                this.elements.activityIndicator.classList.add('active');
                
                clearTimeout(this.activityTimeout);
                this.activityTimeout = setTimeout(() => {
                    this.elements.activityIndicator.classList.remove('active');
                }, 200);
            }
            
            updateConnectionStatus(text, connected) {
                this.elements.statusText.textContent = text;
                this.elements.statusIndicator.classList.toggle('connected', connected);
            }
            
            showGameInfo(data) {
                this.elements.gameTypeBadge.textContent = data.gameType?.toUpperCase() || 'UNKNOWN';
                this.elements.connectedSensors.textContent = `${data.connectedSensors || 0}/${data.maxSensors || 1}`;
                this.elements.gameStatus.textContent = 'ì—°ê²°ë¨';
                
                this.elements.gameInfo.classList.add('visible');
                this.elements.sessionInputSection.style.display = 'none';
                this.elements.qrScannerSection.style.display = 'none';
            }
            
            updatePlayerInfo(data) {
                console.log('ğŸ” updatePlayerInfo í˜¸ì¶œë¨, data:', data);
                
                // ë‹¤ì–‘í•œ ê°€ëŠ¥í•œ í•„ë“œëª… í™•ì¸
                const sensorId = data.sensorId || data.id || data.playerId || data.sensor || '';
                console.log('ğŸ” ì¶”ì¶œëœ sensorId:', sensorId);
                
                // í”Œë ˆì´ì–´ ë²ˆí˜¸ ì¶”ì¶œ (Player1 -> 1, player2 -> 2, sensor1 -> 1 ë“±)
                const playerNumber = sensorId.match(/(\d+)/)?.[1] || '?';
                console.log('ğŸ” ì¶”ì¶œëœ playerNumber:', playerNumber);
                
                // í”Œë ˆì´ì–´ ì •ë³´ ì—…ë°ì´íŠ¸
                this.elements.playerNumber.textContent = playerNumber;
                this.elements.playerName.textContent = playerNumber !== '?' ? `í”Œë ˆì´ì–´ ${playerNumber}` : 'í”Œë ˆì´ì–´';
                this.elements.playerId.textContent = sensorId || 'ì—°ê²° ëŒ€ê¸° ì¤‘...';
                
                // í”Œë ˆì´ì–´ ìƒ‰ìƒ ì ìš©
                this.elements.playerAvatar.className = 'player-avatar';
                if (playerNumber !== '?' && playerNumber >= 1 && playerNumber <= 8) {
                    this.elements.playerAvatar.classList.add(`player-color-${playerNumber}`);
                }
                
                console.log('ğŸ” ìµœì¢… ì—…ë°ì´íŠ¸ëœ ì •ë³´:', {
                    playerNumber: this.elements.playerNumber.textContent,
                    playerName: this.elements.playerName.textContent,
                    playerId: this.elements.playerId.textContent
                });
            }
            
            hideGameInfo() {
                this.elements.gameInfo.classList.remove('visible');
                this.elements.sensorStatus.classList.remove('visible');
                this.elements.sessionInputSection.style.display = 'block';
                this.elements.qrScannerSection.style.display = 'block';
            }
            
            resetConnection() {
                this.state.sessionConnected = false;
                this.state.sensorActive = false;
                this.state.currentSession = null;
                
                if (this.sensorCollector.isActive) {
                    this.sensorCollector.stop();
                }
                
                this.updateConnectionStatus('ì„œë²„ ì—°ê²°ë¨', this.state.connected);
                this.hideGameInfo();
                
                this.elements.connectButton.disabled = this.elements.sessionInput.value.length !== 4 || !this.state.connected;
                this.elements.connectButton.textContent = 'ğŸ”— ê²Œì„ì— ì—°ê²°';
                this.elements.sessionInput.value = '';
            }
            
            checkSensorSupport() {
                if (!this.sensorCollector.checkSensorSupport()) {
                    this.showMessage('ì´ ê¸°ê¸°ëŠ” ì„¼ì„œë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                    this.elements.connectButton.disabled = true;
                    this.elements.qrButton.disabled = true;
                }
            }
            
            showMessage(text, type = 'success') {
                this.elements.message.textContent = text;
                this.elements.message.className = `message ${type} visible`;
                
                setTimeout(() => {
                    this.elements.message.classList.remove('visible');
                }, 5000);
            }
        }
        
        // ì•± ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            new SensorController();
        });
    </script>
</body>
</html>